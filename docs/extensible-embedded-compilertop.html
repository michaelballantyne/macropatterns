<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=0.8"/><title>1&nbsp;Extensible embedded compiler</title><link rel="stylesheet" type="text/css" href="scribble.css" title="default"/><link rel="stylesheet" type="text/css" href="racket.css" title="default"/><link rel="stylesheet" type="text/css" href="figure.css" title="default"/><style type="text/css">
.Figure { border: 1px solid #929292 }
</style><link rel="stylesheet" type="text/css" href="manual-style.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-racket.css" title="default"/><script type="text/javascript" src="scribble-common.js"></script><script type="text/javascript" src="figure.js"></script><script type="text/javascript" src="manual-racket.js"></script><!--[if IE 6]><style type="text/css">.SIEHidden { overflow: hidden; }</style><![endif]--></head><body id="scribble-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist tocviewlisttopspace"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9658;</a></td><td></td><td><a href="index.html" class="tocviewlink" data-pltdoc="x">Racket Macro Patterns</a></td></tr></table></div><div class="tocviewsublisttop" style="display: none;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right"></td><td><a href="Patterns.html" class="tocviewselflink" data-pltdoc="x">Patterns</a></td></tr><tr><td align="right"></td><td><a href="Explainers.html" class="tocviewlink" data-pltdoc="x">Explainers</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_1&quot;);">&#9660;</a></td><td></td><td><a href="Patterns.html" class="tocviewlink" data-pltdoc="x">Patterns</a></td></tr></table><div class="tocviewsublist" style="display: block;" id="tocview_1"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="" class="tocviewselflink" data-pltdoc="x">Extensible embedded compiler</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="literaltop.html" class="tocviewlink" data-pltdoc="x">Literal</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="binding-interfacetop.html" class="tocviewlink" data-pltdoc="x">Binding interface</a></td></tr><tr><td align="right">4&nbsp;</td><td><a href="persistent-symbol-tabletop.html" class="tocviewlink" data-pltdoc="x">Persistent symbol table</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_2&quot;);">&#9658;</a></td><td>1&nbsp;</td><td><a href="" class="tocviewselflink" data-pltdoc="x">Extensible embedded compiler</a></td></tr></table><div class="tocviewsublistbottom" style="display: none;" id="tocview_2"><table cellspacing="0" cellpadding="0"><tr><td align="right">1.1&nbsp;</td><td><a href="#%28part._.Intent%29" class="tocviewlink" data-pltdoc="x">Intent</a></td></tr><tr><td align="right">1.2&nbsp;</td><td><a href="#%28part._.Motivation%29" class="tocviewlink" data-pltdoc="x">Motivation</a></td></tr><tr><td align="right">1.3&nbsp;</td><td><a href="#%28part._.Applicability%29" class="tocviewlink" data-pltdoc="x">Applicability</a></td></tr><tr><td align="right">1.4&nbsp;</td><td><a href="#%28part._.Solution%29" class="tocviewlink" data-pltdoc="x">Solution</a></td></tr><tr><td align="right"></td><td><a href="#%28part._doc-bibliography%29" class="tocviewlink" data-pltdoc="x">Bibliography</a></td></tr></table></div></div></div><div class="tocsub"><div class="tocsubtitle">On this page:</div><table class="tocsublist" cellspacing="0"><tr><td><span class="tocsublinknumber">1.1<tt>&nbsp;</tt></span><a href="#%28part._.Intent%29" class="tocsubseclink" data-pltdoc="x">Intent</a></td></tr><tr><td><span class="tocsublinknumber">1.2<tt>&nbsp;</tt></span><a href="#%28part._.Motivation%29" class="tocsubseclink" data-pltdoc="x">Motivation</a></td></tr><tr><td><span class="tocsublinknumber">1.3<tt>&nbsp;</tt></span><a href="#%28part._.Applicability%29" class="tocsubseclink" data-pltdoc="x">Applicability</a></td></tr><tr><td><span class="tocsublinknumber">1.4<tt>&nbsp;</tt></span><a href="#%28part._.Solution%29" class="tocsubseclink" data-pltdoc="x">Solution</a></td></tr><tr><td><span class="tocsublinknumber">1.4.1<tt>&nbsp;</tt></span><a href="#%28part._.The_vocabulary_of_syntactic_forms%29" class="tocsubseclink" data-pltdoc="x">The vocabulary of syntactic forms</a></td></tr><tr><td><span class="tocsublinknumber">1.4.2<tt>&nbsp;</tt></span><a href="#%28part._.The_expander%29" class="tocsubseclink" data-pltdoc="x">The expander</a></td></tr><tr><td><span class="tocsublinknumber">1.4.3<tt>&nbsp;</tt></span><a href="#%28part._.The_compiler%29" class="tocsubseclink" data-pltdoc="x">The compiler</a></td></tr><tr><td><span class="tocsublinknumber">1.4.4<tt>&nbsp;</tt></span><a href="#%28part._.Embedding_macros%29" class="tocsubseclink" data-pltdoc="x">Embedding macros</a></td></tr><tr><td><span class="tocsublinknumber"></span><a href="#%28part._doc-bibliography%29" class="tocsubseclink" data-pltdoc="x">Bibliography</a></td></tr></table></div></div><div class="maincolumn"><div class="main"><div class="versionbox"><span class="version">7.2</span></div><div class="navsettop"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="Patterns.html" title="backward to &quot;Patterns&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="Patterns.html" title="up to &quot;Patterns&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="literaltop.html" title="forward to &quot;2 Literal&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div><h4>1<tt>&nbsp;</tt><a name="(part._top)"></a>Extensible embedded compiler</h4><h5>1.1<tt>&nbsp;</tt><a name="(part._.Intent)"></a>Intent</h5><p>Extensible embedded compilers are a good way to implement full-featured domain-specific languages that:</p><ul><li><p>can employ multiple passes of analysis and compilation in their implementation.</p></li><li><p>integrate fluidly with Racket and other DSLs while protecting DSL abstractions.</p></li><li><p>are macro-extensible.</p></li></ul><h5>1.2<tt>&nbsp;</tt><a name="(part._.Motivation)"></a>Motivation</h5><p>While one use of macros is to implement new language forms that extend the base Racket language, another is to implement conceptually distinct domain-specific langauges (DSLs).</p><p>A DSL has its own grammar, static semantics, and evaluation model. Implementing these features may require the flexibility of a traditional multi-pass compiler. At the same time, we often want DSLs to integrate fluidly with Racket and other DSLs. And just as programers can create abstractions atop Racket using macros, they should be able to create abstractions atop DSLs as well.</p><p>The extensible embedded compiler pattern is a way of structuring a DSL implementation to support all of these properties. It replicates the structure of the implementation of Racket, using a macro expander tailored to the DSL as front-end and a traditional multi-pass compiler as back-end. The DSL&rsquo;s macro expander shares the Racket expander&rsquo;s hygiene mechanism and expander environment in order to integrate the DSL syntax with Racket.</p><h5>1.3<tt>&nbsp;</tt><a name="(part._.Applicability)"></a>Applicability</h5><p>Use an extensible embedded compiler when:</p><ul><li><p>the implementation of the DSL requires non-local analysis or transformation passes on the DSL syntax such as typechecking, flow analysis, or optimizing compilation.</p></li><li><p><div class="SIntrapara">and either:
</div><div class="SIntrapara"><ul><li><p>the DSL should integrate with Racket or other DSLs via shared variable bindings.</p></li><li><p>DSL definitions should be managed by Racket modules.</p></li><li><p>users of the DSL should be able to abstract over DSL syntax using macros.</p></li></ul></div></p></li></ul><h5>1.4<tt>&nbsp;</tt><a name="(part._.Solution)"></a>Solution</h5><p>The high level components of an extensible embedded compiler are a vocabulary of core syntactic forms, a macro expander, a back-end compiler, and macros to embed the DSL in Racket. The following sections address each component in turn.</p><p>We use the DSL of parsing expression grammars (PEGs) [<a href="#%28cite._peg%29" data-pltdoc="x">peg</a>] as an example to illustrate the pattern. Basic parsing expressions match empty input, characters, sequences, and alternatives. A local binding form enables named recursive grammars.</p><p><table cellspacing="0" cellpadding="0"><tr><td><p><span class="stt">peg := -eps</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">| (-char &lt;character&gt;)</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">| (-seq &lt;peg&gt; &lt;peg&gt;)</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">| (-or &lt;peg&gt; &lt;peg&gt;)</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">| (-local ([&lt;identifier&gt; &lt;peg&gt;]) &lt;peg&gt;)</span></p></td></tr></table></p><p>We embed the DSL in Racket with a syntactic form called <span class="RktSym">parse</span>:</p><p><table cellspacing="0" cellpadding="0"><tr><td><p><span class="stt">racket-exp := (parse &lt;peg&gt; &lt;racket-exp&gt;)</span></p></td></tr></table></p><p>Its Racket sub-expression should evaluate to a string, which will be parsed according to the grammar of the PEG subexpression. The form returns the number of characters of the string that match the grammar.</p><h5>1.4.1<tt>&nbsp;</tt><a name="(part._.The_vocabulary_of_syntactic_forms)"></a>The vocabulary of syntactic forms</h5><p>Racket associates syntactic forms with an identifier binding in a module or local scope, just like runtime bindings. This allows the visibility and name of syntactic forms to be controlled by modules and lexical scope, and is essential to Racket&rsquo;s conception of "languages as libraries". Consequently, the first task in defining a DSL is to create bindings for the core syntactic forms of the DSL.</p><p>When we create identifier bindings, we also have to define their meaning when they appear as normal Racket expressions. DSL forms only make sense in the context of the DSL, so we declare that expansion should raise an error if they appear in a Racket context.</p><p>The <a href="literaltop.html" data-pltdoc="x">Literal</a> pattern describes how to establish the bindings. Using <span class="RktSym">define-literals</span> from <a href="https://github.com/michaelballantyne/syntax-generic2">syntax-generic2</a> to abstract over that pattern, the literal definitions for the PEG language may be written as follows:</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym">define-literal-forms</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktSym">peg-literals</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktVal">"peg forms cannot be used as racket expressions"</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><span class="nobreak">-e</span>ps</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="RktSym"><span class="nobreak">-c</span>har</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="RktSym"><span class="nobreak">-s</span>eq</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="RktSym"><span class="nobreak">-o</span>r</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="RktSym"><span class="nobreak">-l</span>ocal</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><h5>1.4.2<tt>&nbsp;</tt><a name="(part._.The_expander)"></a>The expander</h5><p>The expander checks that a program conforms to the syntax of the DSL, expands macros, and reconstructs fully-expanded syntax. It also needs to construct representations of the program&rsquo;s scopes and bindings in order to implement hygienic name resolution, and because macro names are scoped and may be shadowed.</p><p>As a first step we need to define data structures for the representations of DSL variable and macro bindings in the expander environment. Both kinds of binding need to be distinguished from those belonging to other languages, so we create new structure types to represent them. There isn&rsquo;t any static information associated with PEG variables, so the corresponding structure has no fields. For macros we need to remember the transformer procedure:</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="https://docs.racket-lang.org/reference/begin.html#%28form._%28%28quote._~23~25kernel%29._begin-for-syntax%29%29" class="RktStxLink" data-pltdoc="x">begin-for-syntax</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://docs.racket-lang.org/reference/define-struct.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._struct%29%29" class="RktStxLink" data-pltdoc="x">struct</a></span><span class="hspace">&nbsp;</span><span class="RktSym">peg-variable</span><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://docs.racket-lang.org/reference/define-struct.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._struct%29%29" class="RktStxLink" data-pltdoc="x">struct</a></span><span class="hspace">&nbsp;</span><span class="RktSym">peg-macro</span><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktSym">transformer</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>In DSLs with richer static semantics additional information such as types would be associated with variables. More sophisticated extensible embedded compilers usually employ the <a href="binding-interfacetop.html" data-pltdoc="x">Binding interface</a> pattern in their expander environment representations to allow other languages to create variable bindings that interoperate with the DSL.</p><p>Given the expander environment representations, we can begin to define the expander itself as a phase 1 function that accepts and returns syntax:</p><blockquote class="Figure"><blockquote class="foo"><blockquote class="FigureInside"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">2</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym"><a href="https://docs.racket-lang.org/reference/begin.html#%28form._%28%28quote._~23~25kernel%29._begin-for-syntax%29%29" class="RktStxLink" data-pltdoc="x">begin-for-syntax</a></span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">3</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">define/hygienic</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">expand-peg</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">stx</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">4</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">syntax-parse</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">stx</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">5</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">#:literal-sets</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">peg-literals</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">6</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktCmt">;</span><span class="hspace">&nbsp;</span><span class="RktCmt">Core</span><span class="hspace">&nbsp;</span><span class="RktCmt">forms</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">7</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktSym"><span class="nobreak">-e</span>ps</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">this-syntax</span><span class="RktPn">]</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">8</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym"><span class="nobreak">-c</span>har</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">c:char</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">this-syntax</span><span class="RktPn">]</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">9</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym"><span class="nobreak">-s</span>eq</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">e1</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">e2</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">10</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">def/stx</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">e1^</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">expand-peg</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym"><a href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._syntax%29%29" class="RktStxLink" data-pltdoc="x">#'</a></span><span class="RktSym">e1</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">11</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">def/stx</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">e2^</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">expand-peg</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym"><a href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._syntax%29%29" class="RktStxLink" data-pltdoc="x">#'</a></span><span class="RktSym">e2</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">12</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">qstx/rc</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym"><span class="nobreak">-s</span>eq</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">e1^</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">e2^</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">13</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym"><span class="nobreak">-o</span>r</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">e1</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">e2</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">14</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">def/stx</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">e1^</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">expand-peg</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym"><a href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._syntax%29%29" class="RktStxLink" data-pltdoc="x">#'</a></span><span class="RktSym">e1</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">15</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">def/stx</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">e2^</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">expand-peg</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym"><a href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._syntax%29%29" class="RktStxLink" data-pltdoc="x">#'</a></span><span class="RktSym">e2</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">16</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">qstx/rc</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym"><span class="nobreak">-o</span>r</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">e1^</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">e2^</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">17</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym"><span class="nobreak">-l</span>ocal</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktSym">g</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">e</span><span class="RktPn">]</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">18</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">b</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">19</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym"><a href="https://docs.racket-lang.org/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29" class="RktStxLink" data-pltdoc="x">define</a></span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">sc</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">make-scope</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">20</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">def/stx</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">g^</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">bind!</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">add-scope</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym"><a href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._syntax%29%29" class="RktStxLink" data-pltdoc="x">#'</a></span><span class="RktSym">g</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">sc</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">21</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym"><a href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._syntax%29%29" class="RktStxLink" data-pltdoc="x">#'</a></span><span class="RktPn">(</span><span class="RktSym">peg-variable</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">22</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">def/stx</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">e^</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">expand-peg</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">add-scope</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym"><a href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._syntax%29%29" class="RktStxLink" data-pltdoc="x">#'</a></span><span class="RktSym">e</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">sc</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">23</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">def/stx</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">b^</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">expand-peg</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">add-scope</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym"><a href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._syntax%29%29" class="RktStxLink" data-pltdoc="x">#'</a></span><span class="RktSym">b</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">sc</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">24</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">qstx/rc</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">25</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym"><span class="nobreak">-l</span>ocal</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktSym">g^</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">e^</span><span class="RktPn">]</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">26</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">b^</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">27</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktSym">name:id</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">28</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym"><a href="https://docs.racket-lang.org/reference/when_unless.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._when%29%29" class="RktStxLink" data-pltdoc="x">when</a></span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym"><a href="https://docs.racket-lang.org/reference/booleans.html#%28def._%28%28quote._~23~25kernel%29._not%29%29" class="RktValLink" data-pltdoc="x">not</a></span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">peg-variable?</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym"><a href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._syntax%29%29" class="RktStxLink" data-pltdoc="x">#'</a></span><span class="RktSym">name</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">29</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym"><a href="https://docs.racket-lang.org/reference/exns.html#%28def._%28%28quote._~23~25kernel%29._raise-syntax-error%29%29" class="RktValLink" data-pltdoc="x">raise-syntax-error</a></span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">#f</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"not</span><span class="hspace">&nbsp;</span><span class="RktVal">bound</span><span class="hspace">&nbsp;</span><span class="RktVal">as</span><span class="hspace">&nbsp;</span><span class="RktVal">a</span><span class="hspace">&nbsp;</span><span class="RktVal">peg"</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym"><a href="https://docs.racket-lang.org/reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._syntax%29%29" class="RktStxLink" data-pltdoc="x">#'</a></span><span class="RktSym">name</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">30</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">this-syntax</span><span class="RktPn">]</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">31</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta">&#160;</span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">32</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktCmt">;</span><span class="hspace">&nbsp;</span><span class="RktCmt">Macros</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">33</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym">head</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktMeta">.</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym"><a href="https://docs.racket-lang.org/reference/pairs.html#%28def._%28%28lib._racket%2Flist..rkt%29._rest%29%29" class="RktValLink" data-pltdoc="x">rest</a></span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">34</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">#:when</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">peg-macro?</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">stx</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">35</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">expand-peg</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">36</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">peg-macro</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">stx</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></blockquote><p class="Centertext"><span class="Legend"><span class="FigureTarget"><a name="(counter._(figure._peg-expander))" x-target-lift="Figure"></a>Figure&nbsp;1: </span>PEG DSL Expander</span></p></blockquote><h5>1.4.3<tt>&nbsp;</tt><a name="(part._.The_compiler)"></a>The compiler</h5><p>Phase 1 function over syntax</p><p>Can use apply-as-transformer hygiene to ensure generated code is fresh</p><p>[[Persistent symbol tables]] as needed</p><h5>1.4.4<tt>&nbsp;</tt><a name="(part._.Embedding_macros)"></a>Embedding macros</h5><p>Macro in the language that the DSL is to be embedded in; usually Racket.</p><p>Invoke the expander and the compiler.</p><p>Perform and wrapping or conversion of values between the internal representation of the DSL and the external rep shared with Racket.</p><h5><a name="(part._doc-bibliography)"></a>Bibliography</h5><p><table cellspacing="0" cellpadding="0" class="RBibliography"><tr><td><a name="(cite._peg)"></a>[peg]</td><td><span class="hspace">&nbsp;</span></td><td><span class="bibentry">Bryan Ford, &ldquo;Parsing expression grammars: a recognition-based syntactic foundation,&rdquo; POPL, 2004. <a href="https://doi.org/10.1145/964001.964011"><span class="stt">https://doi.org/10.1145/964001.964011</span></a></span></td></tr></table></p><div class="navsetbottom"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="Patterns.html" title="backward to &quot;Patterns&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="Patterns.html" title="up to &quot;Patterns&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="literaltop.html" title="forward to &quot;2 Literal&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div></div></div><div id="contextindicator">&nbsp;</div></body></html>